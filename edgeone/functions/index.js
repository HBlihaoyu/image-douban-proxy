export default async function onRequest(context) {
  const request = context.request;
  const url = new URL(request.url);
  const currentDomain = url.hostname;
  
  // 如果请求的是 favicon.ico，返回一个简单的 16x16 像素的透明PNG图标
  if (url.pathname === '/favicon.ico') {
    const favicon = new Uint8Array([
      0x89, 0x50, 0x4E, 0x47, 0x0D, 0x0A, 0x1A, 0x0A, 0x00, 0x00, 0x00, 0x0D,
      0x49, 0x48, 0x44, 0x52, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x10,
      0x08, 0x06, 0x00, 0x00, 0x00, 0x1F, 0xF3, 0xFF, 0x61, 0x00, 0x00, 0x00,
      0x06, 0x62, 0x4B, 0x47, 0x44, 0x00, 0xFF, 0x00, 0xFF, 0x00, 0xFF, 0xA0,
      0xBD, 0xA7, 0x93, 0x00, 0x00, 0x00, 0x09, 0x70, 0x48, 0x59, 0x73, 0x00,
      0x00, 0x0B, 0x13, 0x00, 0x00, 0x0B, 0x13, 0x01, 0x00, 0x9A, 0x9C, 0x18,
      0x00, 0x00, 0x00, 0x07, 0x74, 0x49, 0x4D, 0x45, 0x07, 0xD8, 0x0A, 0x17,
      0x0C, 0x1D, 0x2D, 0x9D, 0x18, 0x66, 0x2C, 0x00, 0x00, 0x00, 0x6C, 0x49,
      0x44, 0x41, 0x54, 0x38, 0xCB, 0x63, 0x60, 0x00, 0x02, 0x11, 0x09, 0x29,
      0x69, 0x19, 0x58, 0x24, 0x13, 0x98, 0x98, 0xC5, 0x25, 0xA4, 0x64, 0x60,
      0x91, 0x4C, 0x60, 0x62, 0x96, 0x90, 0x94, 0x96, 0x85, 0x45, 0x32, 0x81,
      0x89, 0x59, 0x42, 0x52, 0x5A, 0x0E, 0x0E, 0xC9, 0x4C, 0x60, 0x62, 0x96,
      0x94, 0x92, 0x96, 0x83, 0x43, 0x32, 0x13, 0x98, 0x98, 0x65, 0x64, 0xE5,
      0xE0, 0x90, 0xCC, 0x04, 0x26, 0x66, 0x59, 0x39, 0x79, 0x78, 0x24, 0x33,
      0x81, 0x89, 0x59, 0x4E, 0x5E, 0x01, 0x1E, 0xC9, 0x4C, 0x60, 0x62, 0x96,
      0x97, 0x57, 0x80, 0x47, 0x32, 0x13, 0x98, 0x98, 0x15, 0x14, 0x15, 0xE1,
      0x91, 0xCC, 0x04, 0x26, 0x66, 0x45, 0x25, 0x65, 0x78, 0x24, 0x33, 0x81,
      0x89, 0x59, 0x49, 0x59, 0x05, 0x1E, 0xC9, 0x00, 0x00, 0x1A, 0x9C, 0x0D,
      0x66, 0xAE, 0x6C, 0x7D, 0x62, 0x00, 0x00, 0x00, 0x00, 0x49, 0x45, 0x4E,
      0x44, 0xAE, 0x42, 0x60, 0x82
    ]);

    return new Response(favicon, {
      status: 200,
      headers: {
        'Content-Type': 'image/x-icon',
        'Cache-Control': 'public, max-age=31536000, immutable',
      }
    });
  }

  // 返回服务说明页面
  const html = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>豆瓣图片代理服务</title>
      <meta charset="utf-8">
      <style>
        body {
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
          max-width: 800px;
          margin: 0 auto;
          padding: 20px;
          background-color: #f5f5f5;
        }
        .container {
          background: white;
          padding: 30px;
          border-radius: 10px;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
          color: #333;
          border-bottom: 2px solid #4a90e2;
          padding-bottom: 10px;
        }
        .example {
          background-color: #f8f9fa;
          border-left: 4px solid #4a90e2;
          padding: 15px;
          margin: 20px 0;
        }
        code {
          background-color: #f1f1f1;
          padding: 2px 6px;
          border-radius: 3px;
          font-family: monospace;
        }
        .note {
          background-color: #fff3cd;
          border: 1px solid #ffeaa7;
          border-radius: 4px;
          padding: 10px;
          margin: 15px 0;
        }
      </style>
    </head>
    <body>
      <div class="container">
        <h1>豆瓣图片代理服务</h1>
        <p>这是一个用于代理访问豆瓣图片资源的服务，用于解决豆瓣图片防盗链问题。</p>
        
        <div class="example">
          <h3>使用方法</h3>
          <p>将豆瓣原始图片链接:</p>
          <code>https://img3.doubanio.com/view/photo/s_ratio_poster/public/p2928448127.webp</code>
          
          <p>替换为:</p>
          <code>https://${currentDomain}/img3.doubanio.com/view/photo/s_ratio_poster/public/p2928448127.webp</code>
        </div>
        
        <div class="note">
          <strong>注意事项:</strong>
          <ul>
            <li>仅支持 doubanio.com 域名下的资源</li>
            <li>所有资源都会被缓存以提高访问速度</li>
            <li>请合理使用，不要用于商业用途</li>
          </ul>
        </div>
        
        <h3>示例</h3>
        <p>访问 <code>/img2.doubanio.com/spic/s2928387071.jpg</code> 来代理 <code>https://img2.doubanio.com/spic/s2928387071.jpg</code></p>
      </div>
    </body>
    </html>
  `;

  return new Response(html, {
    status: 200,
    headers: {
      'Content-Type': 'text/html; charset=utf-8',
      'Cache-Control': 'public, max-age=3600',
    },
  });
}